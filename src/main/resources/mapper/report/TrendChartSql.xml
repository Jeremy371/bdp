<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shinhan.dao.TrendChartDAO">

	<!-- 트렌드차트 -->    
    <select id="getKwdTrendV2" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT RESULT.*
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
					, a.*
				FROM	
						(SELECT 
								 ktc.kwd_a
								, ktc.kwd_b
								, ktc.doc_date
								, ktc.doc_cnt_a
								, ktc.doc_cnt_b
								, ktc.doc_cnt_both
								, ktc.pos_cnt_both
								, ktc.neg_cnt_both
								, ktc.neu_cnt_both
								<if test="param != null">
									<if test="param.kwdList != null and param.kwdList.size != 0">
										, array_position(ARRAY
										<foreach item="item" index="index" collection="param.kwdList" open="[" separator="," close="]">
											#{item}
										</foreach>
										::varchar[], ktc.kwd_a) AS position
								  	</if>
								</if>
						FROM 
								<!-- dm.daily_kwd_trend_cnt_v2 ktc -->
								dm.daily_kwd_trend_cnt_minimal_v2 ktc
						<where>	
							<if test="param != null">
								<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
								<if test="param.startDate != null"> 
									<if test="param.endDate != null">
								 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
								 	</if>
								 </if>
								<if test="param.kwdList != null and param.kwdList.size != 0">
									and ktc.kwd_a IN
									<foreach item="item" index="index" collection="param.kwdList" open="(" separator="," close=")">
								        #{item}
								  	</foreach>
							  	</if>
								<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
								<if test="param.categoryCode != null"> AND left(ktc.category_code, 5) = #{param.categoryCode} </if>
							 </if>
							AND ktc.doc_cnt_both != 0
						 </where>
						) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			<if test="param != null">
				<if test="param.kwdList != null and param.kwdList.size != 0"> position asc, </if>
			</if>
			RESULT.rn,
			RESULT.doc_cnt_both DESC, 
			RESULT.doc_cnt_b DESC
    </select>
    
   	<!-- 트렌드차트 -->    
    <select id="getKwdTrendV3" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT RESULT.*
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
					, a.*
				FROM	
						(SELECT 
								 ktc.kwd_a
								, ktc.kwd_b
								, ktc.doc_date
								, ktc.doc_cnt_a
								, ktc.doc_cnt_b
								, ktc.doc_cnt_both
								<if test="param != null">
									<if test="param.kwdList != null and param.kwdList.size != 0">
										, array_position(ARRAY
										<foreach item="item" index="index" collection="param.kwdList" open="[" separator="," close="]">
											#{item}
										</foreach>
										::varchar[], ktc.kwd_a) AS position
								  	</if>
								</if>
								, dpd.pos_count as pos_cnt_both
                        		, dpd.neg_count as neg_cnt_both
                        		, dpd.neu_count as neu_cnt_both
                        		, dpd.pos_percent
                        		, dpd.neg_percent
                        		, dpd.neu_percent
							FROM 
								<!-- dm.daily_kwd_trend_cnt_v2 ktc -->
								dm.daily_kwd_trend_cnt_minimal_v2 ktc
							LEFT JOIN
		                        dm.daily_doc_sentiment_pie_data dpd
		                  	ON
		                        ktc.kwd_a = dpd.axis_kwd
		                        AND ktc.doc_date = dpd.doc_date
		                        AND ktc.doc_date = dpd.doc_date
		                        AND ktc.fid = dpd.fid
		                        AND ktc.business_code = dpd.business_code
							<where>	
							<if test="param != null">
								<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
								<if test="param.startDate != null"> 
									<if test="param.endDate != null">
								 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
								 	</if>
								 </if>
								<if test="param.kwdList != null and param.kwdList.size != 0">
									and ktc.kwd_a IN
									<foreach item="item" index="index" collection="param.kwdList" open="(" separator="," close=")">
								        #{item}
								  	</foreach>
							  	</if>
								<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
								<if test="param.categoryCode != null"> AND left(ktc.category_code, 5) = #{param.categoryCode} </if>
							 </if>
							AND ktc.doc_cnt_both != 0
						 </where>
						) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			<if test="param != null">
				<if test="param.kwdList != null and param.kwdList.size != 0"> position asc, </if>
			</if>
			RESULT.rn,
			RESULT.doc_cnt_both DESC, 
			RESULT.doc_cnt_b DESC
    </select>
    
    <select id="getWeeklyKwdTrendV2" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT RESULT.*
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
					, a.*
				FROM	
						(SELECT 
								 ktc.kwd_a
								, ktc.kwd_b
								, ktc.doc_date
								, ktc.doc_cnt_a
								, ktc.doc_cnt_b
								, ktc.doc_cnt_both
								, ktc.pos_cnt_both
								, ktc.neg_cnt_both
								, ktc.neu_cnt_both
								<if test="param != null">
									<if test="param.kwdList != null and param.kwdList.size != 0">
										, array_position(ARRAY
										<foreach item="item" index="index" collection="param.kwdList" open="[" separator="," close="]">
											#{item}
										</foreach>
										::varchar[], ktc.kwd_a) AS position
								  	</if>
								</if>
						FROM 
								<!-- dm.weekly_kwd_trend_cnt_v2 ktc -->
								dm.weekly_kwd_trend_cnt_minimal_v2 ktc
						<where>	
							<if test="param != null">
								<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
								<if test="param.startDate != null"> 
									<if test="param.endDate != null">
								 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
								 	</if>
								 </if>
								<if test="param.kwdList != null and param.kwdList.size != 0">
									and ktc.kwd_a IN
									<foreach item="item" index="index" collection="param.kwdList" open="(" separator="," close=")">
								        #{item}
								  	</foreach>
							  	</if>
								<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
								<if test="param.categoryCode != null"> AND left(ktc.category_code, 5) = #{param.categoryCode} </if>
							 </if>
							AND ktc.doc_cnt_both != 0
						 </where>
						) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			<if test="param != null">
				<if test="param.kwdList != null and param.kwdList.size != 0"> position asc, </if>
			</if>
			RESULT.rn,
			RESULT.doc_cnt_both DESC, 
			RESULT.doc_cnt_b DESC
    </select>
    
    <select id="getMonthlyKwdTrendV2" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT RESULT.*
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
					, a.*
				FROM	
						(SELECT 
								 ktc.kwd_a
								, ktc.kwd_b
								, ktc.doc_date
								, ktc.doc_cnt_a
								, ktc.doc_cnt_b
								, ktc.doc_cnt_both
								, ktc.pos_cnt_both
								, ktc.neg_cnt_both
								, ktc.neu_cnt_both
								<if test="param != null">
									<if test="param.kwdList != null and param.kwdList.size != 0">
										, array_position(ARRAY
										<foreach item="item" index="index" collection="param.kwdList" open="[" separator="," close="]">
											#{item}
										</foreach>
										::varchar[], ktc.kwd_a) AS position
								  	</if>
								</if>
						FROM 
								<!-- dm.monthly_kwd_trend_cnt_v2 ktc -->
								dm.monthly_kwd_trend_cnt_minimal_v2 ktc
						<where>	
							<if test="param != null">
								<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
								<if test="param.startDate != null"> 
									<if test="param.endDate != null">
								 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
								 	</if>
								 </if>
								<if test="param.kwdList != null and param.kwdList.size != 0">
									and ktc.kwd_a IN
									<foreach item="item" index="index" collection="param.kwdList" open="(" separator="," close=")">
								        #{item}
								  	</foreach>
							  	</if>
								<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
								<if test="param.categoryCode != null"> AND left(ktc.category_code, 5) = #{param.categoryCode} </if>
							 </if>
							AND ktc.doc_cnt_both != 0
						 </where>
						) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			<if test="param != null">
				<if test="param.kwdList != null and param.kwdList.size != 0"> position asc, </if>
			</if>
			RESULT.rn,
			RESULT.doc_cnt_both DESC, 
			RESULT.doc_cnt_b DESC
    </select>
    
    <select id="getQuarterlyKwdTrendV2" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT RESULT.*
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
					, a.*
				FROM	
						(SELECT 
								 ktc.kwd_a
								, ktc.kwd_b
								, ktc.doc_date
								, ktc.doc_cnt_a
								, ktc.doc_cnt_b
								, ktc.doc_cnt_both
								, ktc.pos_cnt_both
								, ktc.neg_cnt_both
								, ktc.neu_cnt_both
								<if test="param != null">
									<if test="param.kwdList != null and param.kwdList.size != 0">
										, array_position(ARRAY
										<foreach item="item" index="index" collection="param.kwdList" open="[" separator="," close="]">
											#{item}
										</foreach>
										::varchar[], ktc.kwd_a) AS position
								  	</if>
								</if>
						FROM 
								<!--dm.quarterly_kwd_trend_cnt_v2 ktc-->
								dm.quarterly_kwd_trend_cnt_minimal_v2 ktc
						<where>	
							<if test="param != null">
								<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
								<if test="param.startDate != null"> 
									<if test="param.endDate != null">
								 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
								 	</if>
								 </if>
								<if test="param.kwdList != null and param.kwdList.size != 0">
									and ktc.kwd_a IN
									<foreach item="item" index="index" collection="param.kwdList" open="(" separator="," close=")">
								        #{item}
								  	</foreach>
							  	</if>
								<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
								<if test="param.categoryCode != null"> AND left(ktc.category_code, 5) = #{param.categoryCode} </if>
							 </if>
							AND ktc.doc_cnt_both != 0
						 </where>
						) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			<if test="param != null">
				<if test="param.kwdList != null and param.kwdList.size != 0"> position asc, </if>
			</if>
			RESULT.rn,
			RESULT.doc_cnt_both DESC, 
			RESULT.doc_cnt_b DESC
    </select>
    
    <select id="getYearlyKwdTrendV2" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT RESULT.*
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
					, a.*
				FROM	
						(SELECT 
								 ktc.kwd_a
								, ktc.kwd_b
								, ktc.doc_date
								, ktc.doc_cnt_a
								, ktc.doc_cnt_b
								, ktc.doc_cnt_both
								, ktc.pos_cnt_both
								, ktc.neg_cnt_both
								, ktc.neu_cnt_both
								<if test="param != null">
									<if test="param.kwdList != null and param.kwdList.size != 0">
										, array_position(ARRAY
										<foreach item="item" index="index" collection="param.kwdList" open="[" separator="," close="]">
											#{item}
										</foreach>
										::varchar[], ktc.kwd_a) AS position
								  	</if>
								</if>
						FROM 
								<!-- dm.yearly_kwd_trend_cnt_v2 ktc -->
								dm.yearly_kwd_trend_cnt_minimal_v2 ktc
						<where>	
							<if test="param != null">
								<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
								<if test="param.startDate != null"> 
									<if test="param.endDate != null">
								 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
								 	</if>
								 </if>
								<if test="param.kwdList != null and param.kwdList.size != 0">
									and ktc.kwd_a IN
									<foreach item="item" index="index" collection="param.kwdList" open="(" separator="," close=")">
								        #{item}
								  	</foreach>
							  	</if>
								<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
								<if test="param.categoryCode != null"> AND left(ktc.category_code, 5) = #{param.categoryCode} </if>
							 </if>
							AND ktc.doc_cnt_both != 0
						 </where>
						) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			<if test="param != null">
				<if test="param.kwdList != null and param.kwdList.size != 0"> position asc, </if>
			</if>
			RESULT.rn,
			RESULT.doc_cnt_both DESC, 
			RESULT.doc_cnt_b DESC
    </select>
        
    <select id="getWeeklyKwdTrendV3" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT RESULT.*
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
					, a.*
				FROM	
						(SELECT 
								 ktc.kwd_a
								, ktc.kwd_b
								, ktc.doc_date
								, ktc.doc_cnt_a
								, ktc.doc_cnt_b
								, ktc.doc_cnt_both
								<if test="param != null">
									<if test="param.kwdList != null and param.kwdList.size != 0">
										, array_position(ARRAY
										<foreach item="item" index="index" collection="param.kwdList" open="[" separator="," close="]">
											#{item}
										</foreach>
										::varchar[], ktc.kwd_a) AS position
								  	</if>
								</if>
								, dpd.pos_count as pos_cnt_both
                        		, dpd.neg_count as neg_cnt_both
                        		, dpd.neu_count as neu_cnt_both
                        		, dpd.pos_percent
                        		, dpd.neg_percent
                        		, dpd.neu_percent
							FROM 
								<!-- dm.daily_kwd_trend_cnt_v2 ktc -->
								dm.weekly_kwd_trend_cnt_minimal_v2 ktc
							LEFT JOIN
		                        dm.weekly_doc_sentiment_pie_data dpd
		                  	ON
		                        ktc.kwd_a = dpd.axis_kwd
		                        AND ktc.doc_date = dpd.doc_date
		                        AND ktc.doc_date = dpd.doc_date
		                        AND ktc.fid = dpd.fid
		                        AND ktc.business_code = dpd.business_code
							<where>	
							<if test="param != null">
								<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
								<if test="param.startDate != null"> 
									<if test="param.endDate != null">
								 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
								 	</if>
								 </if>
								<if test="param.kwdList != null and param.kwdList.size != 0">
									and ktc.kwd_a IN
									<foreach item="item" index="index" collection="param.kwdList" open="(" separator="," close=")">
								        #{item}
								  	</foreach>
							  	</if>
								<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
								<if test="param.categoryCode != null"> AND left(ktc.category_code, 5) = #{param.categoryCode} </if>
							 </if>
							AND ktc.doc_cnt_both != 0
						 </where>
						) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			<if test="param != null">
				<if test="param.kwdList != null and param.kwdList.size != 0"> position asc, </if>
			</if>
			RESULT.rn,
			RESULT.doc_cnt_both DESC, 
			RESULT.doc_cnt_b DESC
    </select>
    
    <select id="getMonthlyKwdTrendV3" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT RESULT.*
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
					, a.*
				FROM	
						(SELECT 
								 ktc.kwd_a
								, ktc.kwd_b
								, ktc.doc_date
								, ktc.doc_cnt_a
								, ktc.doc_cnt_b
								, ktc.doc_cnt_both
								<if test="param != null">
									<if test="param.kwdList != null and param.kwdList.size != 0">
										, array_position(ARRAY
										<foreach item="item" index="index" collection="param.kwdList" open="[" separator="," close="]">
											#{item}
										</foreach>
										::varchar[], ktc.kwd_a) AS position
								  	</if>
								</if>
								, dpd.pos_count as pos_cnt_both
                        		, dpd.neg_count as neg_cnt_both
                        		, dpd.neu_count as neu_cnt_both
                        		, dpd.pos_percent
                        		, dpd.neg_percent
                        		, dpd.neu_percent
							FROM 
								dm.monthly_kwd_trend_cnt_minimal_v2 ktc
							LEFT JOIN
		                        dm.monthly_doc_sentiment_pie_data dpd
		                  	ON
		                        ktc.kwd_a = dpd.axis_kwd
		                        AND ktc.doc_date = dpd.doc_date
		                        AND ktc.doc_date = dpd.doc_date
		                        AND ktc.fid = dpd.fid
		                        AND ktc.business_code = dpd.business_code
							<where>	
							<if test="param != null">
								<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
								<if test="param.startDate != null"> 
									<if test="param.endDate != null">
								 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
								 	</if>
								 </if>
								<if test="param.kwdList != null and param.kwdList.size != 0">
									and ktc.kwd_a IN
									<foreach item="item" index="index" collection="param.kwdList" open="(" separator="," close=")">
								        #{item}
								  	</foreach>
							  	</if>
								<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
								<if test="param.categoryCode != null"> AND left(ktc.category_code, 5) = #{param.categoryCode} </if>
							 </if>
							AND ktc.doc_cnt_both != 0
						 </where>
						) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			<if test="param != null">
				<if test="param.kwdList != null and param.kwdList.size != 0"> position asc, </if>
			</if>
			RESULT.rn,
			RESULT.doc_cnt_both DESC, 
			RESULT.doc_cnt_b DESC
    </select>
    
    <select id="getQuarterlyKwdTrendV3" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT RESULT.*
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
					, a.*
				FROM	
						(SELECT 
								 ktc.kwd_a
								, ktc.kwd_b
								, ktc.doc_date
								, ktc.doc_cnt_a
								, ktc.doc_cnt_b
								, ktc.doc_cnt_both
								<if test="param != null">
									<if test="param.kwdList != null and param.kwdList.size != 0">
										, array_position(ARRAY
										<foreach item="item" index="index" collection="param.kwdList" open="[" separator="," close="]">
											#{item}
										</foreach>
										::varchar[], ktc.kwd_a) AS position
								  	</if>
								</if>
								, dpd.pos_count as pos_cnt_both
                        		, dpd.neg_count as neg_cnt_both
                        		, dpd.neu_count as neu_cnt_both
                        		, dpd.pos_percent
                        		, dpd.neg_percent
                        		, dpd.neu_percent
							FROM 
								dm.quarterly_kwd_trend_cnt_minimal_v2 ktc
							LEFT JOIN
		                        dm.quarterly_doc_sentiment_pie_data dpd
		                  	ON
		                        ktc.kwd_a = dpd.axis_kwd
		                        AND ktc.doc_date = dpd.doc_date
		                        AND ktc.doc_date = dpd.doc_date
		                        AND ktc.fid = dpd.fid
		                        AND ktc.business_code = dpd.business_code
							<where>	
							<if test="param != null">
								<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
								<if test="param.startDate != null"> 
									<if test="param.endDate != null">
								 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
								 	</if>
								 </if>
								<if test="param.kwdList != null and param.kwdList.size != 0">
									and ktc.kwd_a IN
									<foreach item="item" index="index" collection="param.kwdList" open="(" separator="," close=")">
								        #{item}
								  	</foreach>
							  	</if>
								<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
								<if test="param.categoryCode != null"> AND left(ktc.category_code, 5) = #{param.categoryCode} </if>
							 </if>
							AND ktc.doc_cnt_both != 0
						 </where>
						) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			<if test="param != null">
				<if test="param.kwdList != null and param.kwdList.size != 0"> position asc, </if>
			</if>
			RESULT.rn,
			RESULT.doc_cnt_both DESC, 
			RESULT.doc_cnt_b DESC
    </select>
    
    <select id="getYearlyKwdTrendV3" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT RESULT.*
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
					, a.*
				FROM	
						(SELECT 
								 ktc.kwd_a
								, ktc.kwd_b
								, ktc.doc_date
								, ktc.doc_cnt_a
								, ktc.doc_cnt_b
								, ktc.doc_cnt_both
								<if test="param != null">
									<if test="param.kwdList != null and param.kwdList.size != 0">
										, array_position(ARRAY
										<foreach item="item" index="index" collection="param.kwdList" open="[" separator="," close="]">
											#{item}
										</foreach>
										::varchar[], ktc.kwd_a) AS position
								  	</if>
								</if>
								, dpd.pos_count as pos_cnt_both
                        		, dpd.neg_count as neg_cnt_both
                        		, dpd.neu_count as neu_cnt_both
                        		, dpd.pos_percent
                        		, dpd.neg_percent
                        		, dpd.neu_percent
							FROM 
								dm.yearly_kwd_trend_cnt_minimal_v2 ktc
							LEFT JOIN
		                        dm.yearly_doc_sentiment_pie_data dpd
		                  	ON
		                        ktc.kwd_a = dpd.axis_kwd
		                        AND ktc.doc_date = dpd.doc_date
		                        AND ktc.doc_date = dpd.doc_date
		                        AND ktc.fid = dpd.fid
		                        AND ktc.business_code = dpd.business_code
							<where>	
							<if test="param != null">
								<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
								<if test="param.startDate != null"> 
									<if test="param.endDate != null">
								 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
								 	</if>
								 </if>
								<if test="param.kwdList != null and param.kwdList.size != 0">
									and ktc.kwd_a IN
									<foreach item="item" index="index" collection="param.kwdList" open="(" separator="," close=")">
								        #{item}
								  	</foreach>
							  	</if>
								<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
								<if test="param.categoryCode != null"> AND left(ktc.category_code, 5) = #{param.categoryCode} </if>
							 </if>
							AND ktc.doc_cnt_both != 0
						 </where>
						) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			<if test="param != null">
				<if test="param.kwdList != null and param.kwdList.size != 0"> position asc, </if>
			</if>
			RESULT.rn,
			RESULT.doc_cnt_both DESC, 
			RESULT.doc_cnt_b DESC
    </select>
    
	<!-- 질병 트렌드차트 -->    
    <select id="getKwdDiseaseTrend" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT RESULT.*
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date ORDER BY a.doc_cnt_both DESC)  rn
			  , a.*
				FROM	
					(SELECT
						DISTINCT 
						'질병' as kwd_a
						, ktc.kwd_b
						, ktc.doc_date
						, ktc.doc_cnt_both
						, dpd.pos_count as pos_cnt_both
                    	, dpd.neg_count as neg_cnt_both
                    	, dpd.neu_count as neu_cnt_both
                    	, dpd.pos_percent
                    	, dpd.neg_percent
                    	, dpd.neu_percent
					FROM 
						<!-- dm.daily_kwd_trend_cnt_v2 ktc -->
						dm.daily_kwd_trend_cnt_minimal_v2 ktc
					LEFT JOIN
	                    dm.daily_doc_sentiment_pie_data dpd
                  	ON
                        dpd.axis_kwd = '질병'
                        AND ktc.doc_date = dpd.doc_date
                        AND ktc.fid = dpd.fid
                        AND ktc.business_code = dpd.business_code
						<where>	
						<if test="param != null">
							<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
							<if test="param.startDate != null"> 
								<if test="param.endDate != null">
							 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
							 	</if>
							 </if>
							<if test="param.nerInfoA != null"> AND ktc.ner_info_a like '질병%'</if>
							<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
						 </if>
						AND ktc.doc_cnt_both != 0
					 </where>
					) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			RESULT.rn,
			RESULT.doc_cnt_both DESC
    </select>
    
    <select id="getWeeklyKwdDiseaseTrend" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT RESULT.*
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date ORDER BY a.doc_cnt_both DESC)  rn
			  , a.*
				FROM	
					(SELECT
						DISTINCT 
						'질병' as kwd_a
						, ktc.kwd_b
						, ktc.doc_date
						, ktc.doc_cnt_both
						, dpd.pos_count as pos_cnt_both
                    	, dpd.neg_count as neg_cnt_both
                    	, dpd.neu_count as neu_cnt_both
                    	, dpd.pos_percent
                    	, dpd.neg_percent
                    	, dpd.neu_percent
					FROM 
						<!-- dm.daily_kwd_trend_cnt_v2 ktc -->
						dm.weekly_kwd_trend_cnt_minimal_v2 ktc
					LEFT JOIN
	                    dm.weekly_doc_sentiment_pie_data dpd
                  	ON
                        dpd.axis_kwd = '질병'
                        AND ktc.doc_date = dpd.doc_date
                        AND ktc.fid = dpd.fid
                        AND ktc.business_code = dpd.business_code
						<where>	
						<if test="param != null">
							<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
							<if test="param.startDate != null"> 
								<if test="param.endDate != null">
							 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
							 	</if>
							 </if>
							<if test="param.nerInfoA != null"> AND ktc.ner_info_a like '질병%'</if>
							<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
						 </if>
						AND ktc.doc_cnt_both != 0
					 </where>
					) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			RESULT.rn,
			RESULT.doc_cnt_both DESC
    </select>
    <select id="getMonthlyKwdDiseaseTrend" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT RESULT.*
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date ORDER BY a.doc_cnt_both DESC)  rn
			  , a.*
				FROM	
					(SELECT
						DISTINCT 
						'질병' as kwd_a
						, ktc.kwd_b
						, ktc.doc_date
						, ktc.doc_cnt_both
						, dpd.pos_count as pos_cnt_both
                    	, dpd.neg_count as neg_cnt_both
                    	, dpd.neu_count as neu_cnt_both
                    	, dpd.pos_percent
                    	, dpd.neg_percent
                    	, dpd.neu_percent
					FROM 
						dm.monthly_kwd_trend_cnt_minimal_v2 ktc
					LEFT JOIN
	                    dm.monthly_doc_sentiment_pie_data dpd
                  	ON
                        dpd.axis_kwd = '질병'
                        AND ktc.doc_date = dpd.doc_date
                        AND ktc.fid = dpd.fid
                        AND ktc.business_code = dpd.business_code
						<where>	
						<if test="param != null">
							<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
							<if test="param.startDate != null"> 
								<if test="param.endDate != null">
							 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
							 	</if>
							 </if>
							<if test="param.nerInfoA != null"> AND ktc.ner_info_a like '질병%'</if>
							<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
						 </if>
						AND ktc.doc_cnt_both != 0
					 </where>
					) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			RESULT.rn,
			RESULT.doc_cnt_both DESC
    </select>
    <select id="getQuarterlyKwdDiseaseTrend" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT RESULT.*
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date ORDER BY a.doc_cnt_both DESC)  rn
			  , a.*
				FROM	
					(SELECT
						DISTINCT 
						'질병' as kwd_a
						, ktc.kwd_b
						, ktc.doc_date
						, ktc.doc_cnt_both
						, dpd.pos_count as pos_cnt_both
                    	, dpd.neg_count as neg_cnt_both
                    	, dpd.neu_count as neu_cnt_both
                    	, dpd.pos_percent
                    	, dpd.neg_percent
                    	, dpd.neu_percent
					FROM 
						dm.quarterly_kwd_trend_cnt_minimal_v2 ktc
					LEFT JOIN
	                    dm.quarterly_doc_sentiment_pie_data dpd
                  	ON
                        dpd.axis_kwd = '질병'
                        AND ktc.doc_date = dpd.doc_date
                        AND ktc.fid = dpd.fid
                        AND ktc.business_code = dpd.business_code
						<where>	
						<if test="param != null">
							<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
							<if test="param.startDate != null"> 
								<if test="param.endDate != null">
							 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
							 	</if>
							 </if>
							<if test="param.nerInfoA != null"> AND ktc.ner_info_a like '질병%'</if>
							<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
						 </if>
						AND ktc.doc_cnt_both != 0
					 </where>
					) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			RESULT.rn,
			RESULT.doc_cnt_both DESC
    </select>
    <select id="getYearlyKwdDiseaseTrend" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT RESULT.*
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date ORDER BY a.doc_cnt_both DESC)  rn
			  , a.*
				FROM	
					(SELECT
						DISTINCT 
						'질병' as kwd_a
						, ktc.kwd_b
						, ktc.doc_date
						, ktc.doc_cnt_both
						, dpd.pos_count as pos_cnt_both
                    	, dpd.neg_count as neg_cnt_both
                    	, dpd.neu_count as neu_cnt_both
                    	, dpd.pos_percent
                    	, dpd.neg_percent
                    	, dpd.neu_percent
					FROM 
						dm.yearly_kwd_trend_cnt_minimal_v2 ktc
					LEFT JOIN
	                    dm.yearly_doc_sentiment_pie_data dpd
                  	ON
                        dpd.axis_kwd = '질병'
                        AND ktc.doc_date = dpd.doc_date
                        AND ktc.fid = dpd.fid
                        AND ktc.business_code = dpd.business_code
						<where>	
						<if test="param != null">
							<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
							<if test="param.startDate != null"> 
								<if test="param.endDate != null">
							 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
							 	</if>
							 </if>
							<if test="param.nerInfoA != null"> AND ktc.ner_info_a like '질병%'</if> 
							<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
						 </if>
						AND ktc.doc_cnt_both != 0
					 </where>
					) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			RESULT.rn,
			RESULT.doc_cnt_both DESC
    </select>
    <!-- 채널별 확산 new -->
    <select id="getTrendV2" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
	    SELECT 
	    		RESULT.*
	    FROM (
		    	SELECT 
					ROW_NUMBER() over(partition BY ktc.doc_date ORDER BY ktc.doc_date ASC, ktc.doc_cnt_both DESC) rn,
					ktc.doc_date, 
					ktc.category_code,
					CASE 
						WHEN LEFT(ktc.category_code, 5) = '08202' AND SUBSTRING(ktc.category_code, 6, 2) = '01' THEN 'TWITTER'
					 	WHEN LEFT(ktc.category_code, 5) = '08202' AND SUBSTRING(ktc.category_code, 6, 2) = '02' THEN 'INSTAGRAM'
					 	WHEN LEFT(ktc.category_code, 5) = '08203' THEN 'COMMUNITY'  
					END cId,
					<!--  
					cInfo.channel,
					 -->
					'SNS' as channel,
					ktc.doc_cnt_both
				FROM 
					dm.daily_kwd_trend_cnt_v2 ktc
<!-- 					
				JOIN 
					std.category_std_info cInfo 
				ON cInfo.category_code = ktc.category_code
-->	
				<where>
					<if test="param != null"> 
						<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
						<if test="param.startDate != null"> 
							<if test="param.endDate != null">
								AND ktc.doc_date BETWEEN '${param.startDate}' AND '${param.endDate}'
						 	</if>
						</if>
						<!-- <if test="param.kwdA != null"> 
							<if test="param.kwdB != null"> 
								AND ktc.kwd_a = #{param.kwdA} AND ktc.kwd_b = #{param.kwdB} 
							</if>
						</if> -->
						<if test="param.kwdA != null">AND ktc.kwd_a = #{param.kwdA}</if>
						<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
					</if>
					<![CDATA[AND left(ktc.category_code, 5) <> '08201']]>
				</where>
				ORDER BY 
				<!--  
					ktc.category_code,
				-->
					ktc.doc_date, 
					ktc.doc_cnt_both DESC
			) RESULT
			<where>
				<![CDATA[AND rn = 1]]>
			</where> 
    </select>
    
    <!-- 시장브리핑 - 지수추이 -->
    <select id="getNrtMarketTrend" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyStockDataVO">
    	SELECT 
			sd.isu_cd
			, sd.isu_nm
			, sd.isu_cur_date
			, sd.cur_pr
		FROM 
			dm.near_realtime_stock_data sd
		<where>
			<if test="param != null">
				<if test="param.startDate != null"> 
					<if test="param.endDate != null">
						sd.isu_cur_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
				 	</if>
				</if>
			</if>
			AND (sd.isu_cd = 'KOSPI' OR sd.isu_cd = 'KOSDAQ')
		</where>
		ORDER BY
			sd.isu_cd, sd.isu_cur_date
    </select>
    
    <select id="getMarketTrend" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyStockDataVO">
    	SELECT 
			sd.isu_cd
			, sd.isu_nm
			, sd.isu_cur_date
			, sd.cur_pr
		FROM 
			dm.daily_stock_data sd
		<where>
			<if test="param != null">
				<if test="param.startDate != null"> 
					<if test="param.endDate != null">
						sd.isu_cur_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
				 	</if>
				</if>
			</if>
			AND (sd.isu_cd = 'KOSPI' OR sd.isu_cd = 'KOSDAQ')
		</where>
		ORDER BY
			sd.isu_cd, sd.isu_cur_date
    </select>
    
    <!-- 종목브리핑 - 연관종목리스트 -->
    <select id="getRelStock" parameterType="com.shinhan.vo.ParamVO" resultType="java.lang.String">
		SELECT
				RESULT.kwd_b
		FROM
			(SELECT 
					row_number() over(partition BY doc_date order by kam.doc_date, kam.freq_both DESC, kam.corr_value DESC) rn
					, kam.kwd_b
				FROM 
						dm.daily_kwd_asso_market kam
				<where>
					<if test="param != null">
						<if test="param.fid != null"> AND kam.fid = #{param.fid} </if>
						<if test="param.date != null"> AND kam.doc_date = #{param.date}::DATE </if>
						<if test="param.kwdA != null"> AND kam.kwd_a = #{param.kwdA} </if>
						<if test="param.businessCode != null"> AND kam.business_code = #{param.businessCode} </if>
					</if>
					AND kam.freq_both != 0
				</where>
				GROUP BY 
						 kam.kwd_a
						, kam.kwd_b
						, kam.doc_date
						, kam.freq_both
						, kam.corr_value
				ORDER BY
					kam.doc_date,
					kam.freq_both DESC,
					kam.corr_value DESC
			) RESULT
		<where>
			<![CDATA[RESULT.rn <= 3 ]]>
		</where>
    </select>
    
    <select id="getWeeklyRelStock" parameterType="com.shinhan.vo.ParamVO" resultType="java.lang.String">
		SELECT
				RESULT.kwd_b
		FROM
			(SELECT 
					row_number() over(partition BY doc_date order by kam.doc_date, kam.freq_both DESC, kam.corr_value DESC) rn
					, kam.kwd_b
				FROM 
						dm.weekly_kwd_asso_market kam
				<where>
					<if test="param != null">
						<if test="param.fid != null"> AND kam.fid = #{param.fid} </if>
						<if test="param.date != null"> AND kam.doc_date = #{param.date}::DATE </if>
						<if test="param.kwdA != null"> AND kam.kwd_a = #{param.kwdA} </if>
						<if test="param.businessCode != null"> AND kam.business_code = #{param.businessCode} </if>
					</if>
					AND kam.freq_both != 0
				</where>
				GROUP BY 
						 kam.kwd_a
						, kam.kwd_b
						, kam.doc_date
						, kam.freq_both
						, kam.corr_value
				ORDER BY
					kam.doc_date,
					kam.freq_both DESC,
					kam.corr_value DESC
			) RESULT
		<where>
			<![CDATA[RESULT.rn <= 3 ]]>
		</where>
    </select>
    <select id="getMonthlyRelStock" parameterType="com.shinhan.vo.ParamVO" resultType="java.lang.String">
		SELECT
				RESULT.kwd_b
		FROM
			(SELECT 
					row_number() over(partition BY doc_date order by kam.doc_date, kam.freq_both DESC, kam.corr_value DESC) rn
					, kam.kwd_b
				FROM 
						dm.monthly_kwd_asso_market kam
				<where>
					<if test="param != null">
						<if test="param.fid != null"> AND kam.fid = #{param.fid} </if>
						<if test="param.date != null"> AND kam.doc_date = #{param.date}::DATE </if>
						<if test="param.kwdA != null"> AND kam.kwd_a = #{param.kwdA} </if>
						<if test="param.businessCode != null"> AND kam.business_code = #{param.businessCode} </if>
					</if>
					AND kam.freq_both != 0
				</where>
				GROUP BY 
						 kam.kwd_a
						, kam.kwd_b
						, kam.doc_date
						, kam.freq_both
						, kam.corr_value
				ORDER BY
					kam.doc_date,
					kam.freq_both DESC,
					kam.corr_value DESC
			) RESULT
		<where>
			<![CDATA[RESULT.rn <= 3 ]]>
		</where>
    </select>
    <select id="getQuarterlyRelStock" parameterType="com.shinhan.vo.ParamVO" resultType="java.lang.String">
		SELECT
				RESULT.kwd_b
		FROM
			(SELECT 
					row_number() over(partition BY doc_date order by kam.doc_date, kam.freq_both DESC, kam.corr_value DESC) rn
					, kam.kwd_b
				FROM 
						dm.quarterly_kwd_asso_market kam
				<where>
					<if test="param != null">
						<if test="param.fid != null"> AND kam.fid = #{param.fid} </if>
						<if test="param.date != null"> AND kam.doc_date = #{param.date}::DATE </if>
						<if test="param.kwdA != null"> AND kam.kwd_a = #{param.kwdA} </if>
						<if test="param.businessCode != null"> AND kam.business_code = #{param.businessCode} </if>
					</if>
					AND kam.freq_both != 0
				</where>
				GROUP BY 
						 kam.kwd_a
						, kam.kwd_b
						, kam.doc_date
						, kam.freq_both
						, kam.corr_value
				ORDER BY
					kam.doc_date,
					kam.freq_both DESC,
					kam.corr_value DESC
			) RESULT
		<where>
			<![CDATA[RESULT.rn <= 3 ]]>
		</where>
    </select>
    <select id="getYearlyRelStock" parameterType="com.shinhan.vo.ParamVO" resultType="java.lang.String">
		SELECT
				RESULT.kwd_b
		FROM
			(SELECT 
					row_number() over(partition BY doc_date order by kam.doc_date, kam.freq_both DESC, kam.corr_value DESC) rn
					, kam.kwd_b
				FROM 
						dm.yearly_kwd_asso_market kam
				<where>
					<if test="param != null">
						<if test="param.fid != null"> AND kam.fid = #{param.fid} </if>
						<if test="param.date != null"> AND kam.doc_date = #{param.date}::DATE </if>
						<if test="param.kwdA != null"> AND kam.kwd_a = #{param.kwdA} </if>
						<if test="param.businessCode != null"> AND kam.business_code = #{param.businessCode} </if>
					</if>
					AND kam.freq_both != 0
				</where>
				GROUP BY 
						 kam.kwd_a
						, kam.kwd_b
						, kam.doc_date
						, kam.freq_both
						, kam.corr_value
				ORDER BY
					kam.doc_date,
					kam.freq_both DESC,
					kam.corr_value DESC
			) RESULT
		<where>
			<![CDATA[RESULT.rn <= 3 ]]>
		</where>
    </select>
    
    <!-- 금투 - 연관종목 트렌드차트 -->
    <select id="getStockKwdTrendV2" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
    	SELECT
    		RESULT.rn 
			, RESULT.kwd_a
			, RESULT.kwd_b
			, RESULT.doc_date
			, RESULT.doc_cnt_both
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
					, a.*
				FROM	
					(SELECT
							kam.fid 
							, kam.kwd_a
							, kam.kwd_b
							, kam.doc_date
							, kam.freq_both as doc_cnt_both
							, kam.corr_value
							<if test="param != null">
								<if test="param.kwdList != null and param.kwdList.size != 0">
									, array_position(ARRAY
									<foreach item="item" index="index" collection="param.kwdList" open="[" separator="," close="]">
										#{item}
									</foreach>
									::varchar[], kam.kwd_a) AS position
							  	</if>
							</if>
					FROM 
							dm.daily_kwd_asso_market kam
					<where>	
						<if test="param != null">
							<if test="param.fid != null"> AND kam.fid = #{param.fid} </if>
							<if test="param.startDate != null"> 
								<if test="param.endDate != null">
							 		AND kam.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
							 	</if>
							 </if>
							<if test="param.kwdList != null and param.kwdList.size != 0">
								and kam.kwd_a IN
								<foreach item="item" index="index" collection="param.kwdList" open="(" separator="," close=")">
							        #{item}
							  	</foreach>
						  	</if>
							<if test="param.businessCode != null"> AND kam.business_code = #{param.businessCode} </if>
						 </if>
							AND kam.freq_both != 0
					 </where>
					GROUP BY
							kam.fid 
							, kam.kwd_a
							, kam.kwd_b
							, kam.doc_date
							, kam.freq_both
							, kam.corr_value
					) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			<if test="param != null">
				<if test="param.kwdList != null and param.kwdList.size != 0"> position asc, </if>
			</if>
			RESULT.rn,
			RESULT.doc_cnt_both DESC
    </select>
    
    <!-- 연관종목 트렌드차트 new -->
    <select id="getStockKwdTrendV3" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
    
		SELECT 
			 RESULT.*
		FROM (
				SELECT 
					row_number() over(partition BY isu_dcs_date, isu_nm) as rn
					, isu_nm kwd_a
					, isu_nm kwd_b
					, isu_dcs_date doc_date
					, mn_cnt doc_cnt_both
					<if test="param != null">
						<if test="param.kwdList != null and param.kwdList.size != 0">
							, array_position(ARRAY
							<foreach item="item" index="index" collection="param.kwdList" open="[" separator="," close="]">
								#{item}
							</foreach>
							::varchar[], isu_nm) AS POSITION
					  	</if>
					</if>
				FROM 
					dm.stock_market_top
				<where>	
					<if test="param != null">
						<if test="param.kwdList != null and param.kwdList.size != 0">
							and isu_nm IN
							<foreach item="item" index="index" collection="param.kwdList" open="(" separator="," close=")">
						        #{item}
						  	</foreach>
						 </if>
						<if test="param.startDate != null"> 
							<if test="param.endDate != null">
						 		AND isu_dcs_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
						 	</if>
						 </if>
					</if>
				</where>	
		) RESULT
		where 
			<![CDATA[rn = 1 ]]>
		ORDER BY 
			RESULT.doc_date
			<if test="param != null">
				<if test="param.kwdList != null and param.kwdList.size != 0"> , RESULT.position asc</if>
			</if>
    </select>
    
    
    <select id="getWeeklyStockKwdTrendV2" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT 
    		RESULT.rn
			, RESULT.kwd_a
			, RESULT.kwd_b
			, RESULT.doc_date
			, RESULT.doc_cnt_both
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
					, a.*
				FROM	
					(SELECT
							kam.fid 
							, kam.kwd_a
							, kam.kwd_b
							, kam.doc_date
							, kam.freq_both as doc_cnt_both
							, kam.corr_value
							<if test="param != null">
								<if test="param.kwdList != null and param.kwdList.size != 0">
									, array_position(ARRAY
									<foreach item="item" index="index" collection="param.kwdList" open="[" separator="," close="]">
										#{item}
									</foreach>
									::varchar[], kam.kwd_a) AS position
							  	</if>
							</if>
					FROM 
							dm.weekly_kwd_asso_market kam
					<where>	
						<if test="param != null">
							<if test="param.fid != null"> AND kam.fid = #{param.fid} </if>
							<if test="param.startDate != null"> 
								<if test="param.endDate != null">
							 		AND kam.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
							 	</if>
							 </if>
							<if test="param.kwdList != null and param.kwdList.size != 0">
								and kam.kwd_a IN
								<foreach item="item" index="index" collection="param.kwdList" open="(" separator="," close=")">
							        #{item}
							  	</foreach>
						  	</if>
							<if test="param.businessCode != null"> AND kam.business_code = #{param.businessCode} </if>
						 </if>
							AND kam.freq_both != 0
					 </where>
					GROUP BY
							kam.fid 
							, kam.kwd_a
							, kam.kwd_b
							, kam.doc_date
							, kam.freq_both
							, kam.corr_value
					) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			<if test="param != null">
				<if test="param.kwdList != null and param.kwdList.size != 0"> position asc, </if>
			</if>
			RESULT.rn,
			RESULT.doc_cnt_both DESC
    </select>
    
    <select id="getMonthlyStockKwdTrendV2" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT 
    		RESULT.rn
			, RESULT.kwd_a
			, RESULT.kwd_b
			, RESULT.doc_date
			, RESULT.doc_cnt_both
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
					, a.*
				FROM	
					(SELECT
							kam.fid 
							, kam.kwd_a
							, kam.kwd_b
							, kam.doc_date
							, kam.freq_both as doc_cnt_both
							, kam.corr_value
							<if test="param != null">
								<if test="param.kwdList != null and param.kwdList.size != 0">
									, array_position(ARRAY
									<foreach item="item" index="index" collection="param.kwdList" open="[" separator="," close="]">
										#{item}
									</foreach>
									::varchar[], kam.kwd_a) AS position
							  	</if>
							</if>
					FROM 
							dm.monthly_kwd_asso_market kam
					<where>	
						<if test="param != null">
							<if test="param.fid != null"> AND kam.fid = #{param.fid} </if>
							<if test="param.startDate != null"> 
								<if test="param.endDate != null">
							 		AND kam.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
							 	</if>
							 </if>
							<if test="param.kwdList != null and param.kwdList.size != 0">
								and kam.kwd_a IN
								<foreach item="item" index="index" collection="param.kwdList" open="(" separator="," close=")">
							        #{item}
							  	</foreach>
						  	</if>
							<if test="param.businessCode != null"> AND kam.business_code = #{param.businessCode} </if>
						 </if>
							AND kam.freq_both != 0
					 </where>
					GROUP BY
							kam.fid 
							, kam.kwd_a
							, kam.kwd_b
							, kam.doc_date
							, kam.freq_both
							, kam.corr_value
					) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			<if test="param != null">
				<if test="param.kwdList != null and param.kwdList.size != 0"> position asc, </if>
			</if>
			RESULT.rn,
			RESULT.doc_cnt_both DESC
    </select>
    
    <select id="getQuarterlyStockKwdTrendV2" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT 
    		RESULT.rn
			, RESULT.kwd_a
			, RESULT.kwd_b
			, RESULT.doc_date
			, RESULT.doc_cnt_both
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
					, a.*
				FROM	
					(SELECT
							kam.fid 
							, kam.kwd_a
							, kam.kwd_b
							, kam.doc_date
							, kam.freq_both as doc_cnt_both
							, kam.corr_value
							<if test="param != null">
								<if test="param.kwdList != null and param.kwdList.size != 0">
									, array_position(ARRAY
									<foreach item="item" index="index" collection="param.kwdList" open="[" separator="," close="]">
										#{item}
									</foreach>
									::varchar[], kam.kwd_a) AS position
							  	</if>
							</if>
					FROM 
							dm.quarterly_kwd_asso_market kam
					<where>	
						<if test="param != null">
							<if test="param.fid != null"> AND kam.fid = #{param.fid} </if>
							<if test="param.startDate != null"> 
								<if test="param.endDate != null">
							 		AND kam.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
							 	</if>
							 </if>
							<if test="param.kwdList != null and param.kwdList.size != 0">
								and kam.kwd_a IN
								<foreach item="item" index="index" collection="param.kwdList" open="(" separator="," close=")">
							        #{item}
							  	</foreach>
						  	</if>
							<if test="param.businessCode != null"> AND kam.business_code = #{param.businessCode} </if>
						 </if>
							AND kam.freq_both != 0
					 </where>
					GROUP BY
							kam.fid 
							, kam.kwd_a
							, kam.kwd_b
							, kam.doc_date
							, kam.freq_both
							, kam.corr_value
					) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			<if test="param != null">
				<if test="param.kwdList != null and param.kwdList.size != 0"> position asc, </if>
			</if>
			RESULT.rn,
			RESULT.doc_cnt_both DESC
    </select>
    
    <select id="getYearlyStockKwdTrendV2" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
		SELECT 
    		RESULT.rn
			, RESULT.kwd_a
			, RESULT.kwd_b
			, RESULT.doc_date
			, RESULT.doc_cnt_both
		FROM
			(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
					, a.*
				FROM	
					(SELECT
							kam.fid 
							, kam.kwd_a
							, kam.kwd_b
							, kam.doc_date
							, kam.freq_both as doc_cnt_both
							, kam.corr_value
							<if test="param != null">
								<if test="param.kwdList != null and param.kwdList.size != 0">
									, array_position(ARRAY
									<foreach item="item" index="index" collection="param.kwdList" open="[" separator="," close="]">
										#{item}
									</foreach>
									::varchar[], kam.kwd_a) AS position
							  	</if>
							</if>
					FROM 
							dm.yearly_kwd_asso_market kam
					<where>	
						<if test="param != null">
							<if test="param.fid != null"> AND kam.fid = #{param.fid} </if>
							<if test="param.startDate != null"> 
								<if test="param.endDate != null">
							 		AND kam.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
							 	</if>
							 </if>
							<if test="param.kwdList != null and param.kwdList.size != 0">
								and kam.kwd_a IN
								<foreach item="item" index="index" collection="param.kwdList" open="(" separator="," close=")">
							        #{item}
							  	</foreach>
						  	</if>
							<if test="param.businessCode != null"> AND kam.business_code = #{param.businessCode} </if>
						 </if>
							AND kam.freq_both != 0
					 </where>
					GROUP BY
							kam.fid 
							, kam.kwd_a
							, kam.kwd_b
							, kam.doc_date
							, kam.freq_both
							, kam.corr_value
					) a
			) RESULT
		WHERE 
			<![CDATA[rn <= 3 ]]>
		ORDER BY
			RESULT.doc_date,
			<if test="param != null">
				<if test="param.kwdList != null and param.kwdList.size != 0"> position asc, </if>
			</if>
			RESULT.rn,
			RESULT.doc_cnt_both DESC
    </select>
    
    <!-- 금투 - 연관종목 Top1 연관키워드 트렌드차트 -->
    <select id="getIsuRelKwds" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
	    SELECT 
    		RESULT.rn
			, RESULT.kwd_a
			, RESULT.kwd_b
			, RESULT.doc_date
			, RESULT.doc_cnt_both
			FROM
				(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
						, a.*
					FROM	
							(SELECT
									fid 
									, ktc.kwd_a
									, ktc.kwd_b
									, ktc.doc_date
									, ktc.doc_cnt_both
							FROM 
									<!-- dm.daily_kwd_trend_cnt_v2 ktc -->
									dm.daily_kwd_trend_cnt_minimal_v2 ktc
							<where>	
								<if test="param != null">
									<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
									<if test="param.kwdA != null"> AND ktc.kwd_a  = #{param.kwdA} </if>
									<if test="param.startDate != null"> 
										<if test="param.endDate != null">
									 		AND ktc.doc_date BETWEEN '${param.startDate}' AND '${param.endDate}'
									 	</if>
									 </if>
									<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
								 </if>
								AND ktc.doc_cnt_both != 0
							 </where>
							GROUP BY
									fid 
									, ktc.kwd_a
									, ktc.kwd_b
									, ktc.doc_date
									, ktc.doc_cnt_both
							) a
				) RESULT
			WHERE 
				<![CDATA[rn <= 3 ]]>
			ORDER BY
				RESULT.doc_date,
				RESULT.rn,
				RESULT.doc_cnt_both DESC
    </select>
    
    <select id="getWeeklyIsuRelKwds" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
	    SELECT  
    		RESULT.rn
			, RESULT.kwd_a
			, RESULT.kwd_b
			, RESULT.doc_date
			, RESULT.doc_cnt_both
			FROM
				(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
						, a.*
					FROM	
							(SELECT
									fid 
									, ktc.kwd_a
									, ktc.kwd_b
									, ktc.doc_date
									, ktc.doc_cnt_both
							FROM 
									dm.weekly_kwd_trend_cnt_v2 ktc
							<where>	
								<if test="param != null">
									<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
									<if test="param.kwdA != null"> AND ktc.kwd_a  = #{param.kwdA} </if>
									<if test="param.startDate != null"> 
										<if test="param.endDate != null">
									 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
									 	</if>
									 </if>
									<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
								 </if>
								AND ktc.doc_cnt_both != 0
							 </where>
							GROUP BY
									fid 
									, ktc.kwd_a
									, ktc.kwd_b
									, ktc.doc_date
									, ktc.doc_cnt_both
							) a
				) RESULT
			WHERE 
				<![CDATA[rn <= 3 ]]>
			ORDER BY
				RESULT.doc_date,
				RESULT.rn,
				RESULT.doc_cnt_both DESC
    </select>
    
    <select id="getMonthlyIsuRelKwds" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
	    SELECT  
    		RESULT.rn
			, RESULT.kwd_a
			, RESULT.kwd_b
			, RESULT.doc_date
			, RESULT.doc_cnt_both
			FROM
				(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
						, a.*
					FROM	
							(SELECT
									fid 
									, ktc.kwd_a
									, ktc.kwd_b
									, ktc.doc_date
									, ktc.doc_cnt_both
							FROM 
									dm.monthly_kwd_trend_cnt_v2 ktc
							<where>	
								<if test="param != null">
									<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
									<if test="param.kwdA != null"> AND ktc.kwd_a  = #{param.kwdA} </if>
									<if test="param.startDate != null"> 
										<if test="param.endDate != null">
									 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
									 	</if>
									 </if>
									<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
								 </if>
								AND ktc.doc_cnt_both != 0
							 </where>
							GROUP BY
									fid 
									, ktc.kwd_a
									, ktc.kwd_b
									, ktc.doc_date
									, ktc.doc_cnt_both
							) a
				) RESULT
			WHERE 
				<![CDATA[rn <= 3 ]]>
			ORDER BY
				RESULT.doc_date,
				RESULT.rn,
				RESULT.doc_cnt_both DESC
    </select>
    
    <select id="getQuarterlyIsuRelKwds" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
	    SELECT  
    		RESULT.rn
			, RESULT.kwd_a
			, RESULT.kwd_b
			, RESULT.doc_date
			, RESULT.doc_cnt_both
			FROM
				(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
						, a.*
					FROM	
							(SELECT
									fid 
									, ktc.kwd_a
									, ktc.kwd_b
									, ktc.doc_date
									, ktc.doc_cnt_both
							FROM 
									dm.quarterly_kwd_trend_cnt_v2 ktc
							<where>	
								<if test="param != null">
									<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
									<if test="param.kwdA != null"> AND ktc.kwd_a  = #{param.kwdA} </if>
									<if test="param.startDate != null"> 
										<if test="param.endDate != null">
									 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
									 	</if>
									 </if>
									<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
								 </if>
								AND ktc.doc_cnt_both != 0
							 </where>
							GROUP BY
									fid 
									, ktc.kwd_a
									, ktc.kwd_b
									, ktc.doc_date
									, ktc.doc_cnt_both
							) a
				) RESULT
			WHERE 
				<![CDATA[rn <= 3 ]]>
			ORDER BY
				RESULT.doc_date,
				RESULT.rn,
				RESULT.doc_cnt_both DESC
    </select>
    
    <select id="getYearlyIsuRelKwds" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyKwdTrendCntV2VO">
	    SELECT  
    		RESULT.rn
			, RESULT.kwd_a
			, RESULT.kwd_b
			, RESULT.doc_date
			, RESULT.doc_cnt_both
			FROM
				(SELECT row_number() over(PARTITION BY a.doc_date, a.kwd_a ORDER BY a.doc_cnt_both DESC)  rn
						, a.*
					FROM	
							(SELECT
									fid 
									, ktc.kwd_a
									, ktc.kwd_b
									, ktc.doc_date
									, ktc.doc_cnt_both
							FROM 
									dm.yearly_kwd_trend_cnt_v2 ktc
							<where>	
								<if test="param != null">
									<if test="param.fid != null"> AND ktc.fid = #{param.fid} </if>
									<if test="param.kwdA != null"> AND ktc.kwd_a  = #{param.kwdA} </if>
									<if test="param.startDate != null"> 
										<if test="param.endDate != null">
									 		AND ktc.doc_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
									 	</if>
									 </if>
									<if test="param.businessCode != null"> AND ktc.business_code = #{param.businessCode} </if>
								 </if>
								AND ktc.doc_cnt_both != 0
							 </where>
							GROUP BY
									fid 
									, ktc.kwd_a
									, ktc.kwd_b
									, ktc.doc_date
									, ktc.doc_cnt_both
							) a
				) RESULT
			WHERE 
				<![CDATA[rn <= 3 ]]>
			ORDER BY
				RESULT.doc_date,
				RESULT.rn,
				RESULT.doc_cnt_both DESC
    </select>
    
    <!-- 금투 - 종목브리핑 - 종목검색 -->
    <select id="getStockInfo" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyStockDataVO">
		SELECT 
			sd.isu_cd
			, sd.isu_nm
			, sd.isu_cur_date
			, sd.cur_pr
			, sd.fluc_tp_cd
			, sd.prv_dd_cmpr
			, sd.updn_rate
		FROM dm.daily_stock_data sd
	    <where>
		    <if test="param != null">
		    	<if test="param.kwd != null"> AND sd.isu_nm = #{param.kwd} </if>
		    	<if test="param.startDate != null">
		    		<if test="param.endDate">
		    			AND sd.isu_cur_date BETWEEN #{param.startDate}::DATE AND #{param.endDate}::DATE
		    		</if>
		    	</if>
		    </if>
	    </where>
		ORDER BY sd.isu_cur_date ASC
    </select>
    
    <select id="getNrtStockInfo" parameterType="com.shinhan.vo.ParamVO" resultType="com.shinhan.vo.DailyStockDataVO">
		SELECT 
			sd.isu_cd
			, sd.isu_nm
			, sd.isu_cur_date
			, sd.cur_pr
			, sd.fluc_tp_cd
			, sd.prv_dd_cmpr
			, sd.updn_rate
		FROM dm.near_realtime_stock_data sd
	    <where>
		    <if test="param != null">
		    	<if test="param.kwd != null"> AND sd.isu_nm = #{param.kwd} </if>
		    	<if test="param.startDate != null">
		    		<if test="param.endDate">
		    			AND sd.isu_cur_date BETWEEN #{param.startDate}::TIMESTAMP AND #{param.endDate}::TIMESTAMP
		    		</if>
		    	</if>
		    </if>
	    </where>
		ORDER BY sd.isu_cur_date ASC
    </select>
</mapper>